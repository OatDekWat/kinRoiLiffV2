<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; padding: 20px; }
    .table-btn { width: 100%; height: 80px; margin-bottom: 15px; font-size: 1.2rem; border-radius: 10px; }
    .status-available { background-color: #28a745; color: white; }
    .status-booked { background-color: #dc3545; color: white; cursor: not-allowed; opacity: 0.6; }
    .loading { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>

  <div class="container">
    <h3 class="text-center mb-4">üçΩÔ∏è ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
    
    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞...</div>
    
    <div class="row" id="tableContainer" style="display:none;">
      </div>
  </div>

  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà <span id="selectedTable"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="bookingForm">
            <input type="hidden" id="userId">
            <div class="mb-3">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
              <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
              <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
              <input type="tel" class="form-control" id="phone" required>
            </div>
            <div class="mb-3">
              <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</label>
              <input type="time" class="form-control" id="time" required>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="submitBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const LIFF_ID = "2008852653-NMn9sh6P"; 
    // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* URL ‡∏Ç‡∏≠‡∏á Web App
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxM6vaLvhW0Z2S1hYCKcERwf3H14Ukx0Sk9WezymTkz6Y7T_Q__gqTklMXUt29vdl9S/exec";

    let liffProfile = null;

    async function main() {
      // ‡πÇ‡∏´‡∏•‡∏î LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        liffProfile = await liff.getProfile();
        document.getElementById('userId').value = liffProfile.userId;
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ LIFF ‡πÅ‡∏•‡πâ‡∏ß
        loadTableStatus();
      } catch (err) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Browser ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ LIFF Error ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Error
        console.error(err);
        document.getElementById('loading').innerText = "‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE)";
        // ‡∏¢‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏ú‡∏∑‡πà‡∏≠ test ‡πÉ‡∏ô browser
        loadTableStatus();
      }
    }

    function loadTableStatus() {
      // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Redirect
      fetch(SCRIPT_URL + '?func=getStatus', {
          method: 'GET',
          redirect: 'follow' // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏° GAS Redirect ‡πÑ‡∏î‡πâ
      })
      .then(res => res.json())
      .then(data => {
        renderTables(data);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'flex';
      })
      .catch(err => {
         document.getElementById('loading').innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
         console.error(err);
      });
    }

    function renderTables(data) {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';
      
      data.forEach(item => {
        const tableNo = item[0];
        const status = item[1]; 
        
        const col = document.createElement('div');
        col.className = 'col-4 col-md-3';
        
        const btn = document.createElement('button');
        const isBooked = status !== 'Available';
        btn.className = `btn table-btn ${isBooked ? 'status-booked' : 'status-available'}`;
        btn.innerHTML = `‡πÇ‡∏ï‡πä‡∏∞ ${tableNo}<br><small>${isBooked ? '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á' : '‡∏ß‡πà‡∏≤‡∏á'}</small>`;
        btn.disabled = isBooked;
        
        if (!isBooked) {
          btn.onclick = () => openBookingModal(tableNo);
        }
        
        col.appendChild(btn);
        container.appendChild(col);
      });
    }

    function openBookingModal(tableNo) {
      document.getElementById('selectedTable').innerText = tableNo;
      const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
      modal.show();
      
      // ‡∏•‡πâ‡∏≤‡∏á event ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡πâ‡∏•
      const form = document.getElementById('bookingForm');
      form.onsubmit = null; 
      
      form.onsubmit = function(e) {
        e.preventDefault();
        submitBooking(tableNo, modal);
      };
    }

    function submitBooking(tableNo, modalInstance) {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      const name = document.getElementById('name').value;
      const phone = document.getElementById('phone').value;
      const time = document.getElementById('time').value;

      const formData = {
        action: 'book',
        tableNo: tableNo,
        name: name,
        phone: phone,
        time: time,
        userId: liffProfile ? liffProfile.userId : 'Browser_Test'
      };

      // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
      fetch(SCRIPT_URL, {
        method: 'POST',
        redirect: 'follow', // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á
        headers: {
            "Content-Type": "text/plain;charset=utf-8", // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Preflight check
        },
        body: JSON.stringify(formData)
      })
      .then(res => res.json())
      .then(response => {
        if (response.status === 'success') {
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
          if (liff.isInClient()) {
             liff.sendMessages([
              {
                type: 'text',
                text: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á\n‡∏ä‡∏∑‡πà‡∏≠:${name}\n‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:${phone}\n‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤:${time}\n(‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞:${tableNo})`
              }
            ]).then(() => {
              Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
                modalInstance.hide();
                liff.closeWindow(); 
              });
            }).catch((err) => {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏¥‡∏î scope) ‡πÅ‡∏ï‡πà‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              console.error('LIFF send error', err);
              Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)', 'warning').then(()=>{
                 modalInstance.hide();
                 liff.closeWindow();
              });
            });
          } else {
             // ‡∏Å‡∏£‡∏ì‡∏µ Test ‡πÉ‡∏ô Browser 
             Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Browser Mode)', 'success').then(() => {
                modalInstance.hide();
                loadTableStatus(); // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
             });
          }

        } else {
          Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', response.message, 'error');
          btn.disabled = false;
          btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        }
      })
      .catch(err => {
        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + err, 'error');
        btn.disabled = false;
        btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
      });
    }

    main();
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>